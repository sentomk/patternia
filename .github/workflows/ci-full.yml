name: CI - Full (C++17/20/23 matrix)

on:
  push:
    branches:
      - main
      - ci/workflows
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1' # weekly (UTC)

jobs:
  build-matrix:
    name: Build & Test (${{ matrix.os }} / ${{ matrix.compiler }} / c++${{ matrix.cpp_std }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu - gcc/clang (Ninja)
          - os: ubuntu-latest
            compiler: gcc
            cpp_std: 17
            generator: ninja
          - os: ubuntu-latest
            compiler: gcc
            cpp_std: 20
            generator: ninja
          - os: ubuntu-latest
            compiler: gcc
            cpp_std: 23
            generator: ninja
          - os: ubuntu-latest
            compiler: clang
            cpp_std: 17
            generator: ninja
          - os: ubuntu-latest
            compiler: clang
            cpp_std: 20
            generator: ninja
          - os: ubuntu-latest
            compiler: clang
            cpp_std: 23
            generator: ninja
          # macOS - AppleClang (Ninja)
          - os: macos-latest
            compiler: clang
            cpp_std: 17
            generator: ninja
          - os: macos-latest
            compiler: clang
            cpp_std: 20
            generator: ninja
          - os: macos-latest
            compiler: clang
            cpp_std: 23
            generator: ninja
          # Windows - MSVC (VS 2022)
          - os: windows-latest
            compiler: msvc
            cpp_std: 17
            generator: vs17
          - os: windows-latest
            compiler: msvc
            cpp_std: 20
            generator: vs17
          - os: windows-latest
            compiler: msvc
            cpp_std: 23
            generator: vs17

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 建议：不要缓存整个 build 目录；如果你坚持缓存，至少把 generator 放进 key
      - name: Cache build dir (optional)
        uses: actions/cache@v4
        with:
          path: build
          key: full-${{ runner.os }}-cmake-${{ matrix.compiler }}-std${{ matrix.cpp_std }}-gen-${{ matrix.generator }}-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}
          restore-keys: |
            full-${{ runner.os }}-cmake-${{ matrix.compiler }}-std${{ matrix.cpp_std }}-gen-${{ matrix.generator }}-

      # ---- Dependencies per platform ----
      - name: Prepare (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build ccache

      - name: Prepare (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install ninja || true

      # ---- Clean stale build dir if generator mismatched ----
      - name: Ensure clean build dir for Ninja (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f build/CMakeCache.txt ]; then
            if ! grep -q 'CMAKE_GENERATOR:INTERNAL=Ninja' build/CMakeCache.txt; then
              rm -rf build
            fi
          fi
          mkdir -p build

      - name: Ensure clean build dir for VS (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path build/CMakeCache.txt) {
            $gen = Select-String -Path build/CMakeCache.txt -Pattern 'CMAKE_GENERATOR:INTERNAL=(.*)' | ForEach-Object { $_.Matches[0].Groups[1].Value }
            if ($gen -notlike 'Visual Studio*') {
              Remove-Item -Recurse -Force build
            }
          }
          New-Item -ItemType Directory -Force -Path build | Out-Null

      # ---- Configure ----
      - name: Configure (Linux/macOS, Ninja)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            export CC=clang
            export CXX=clang++
          else
            export CC=gcc
            export CXX=g++
          fi
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=${{ matrix.cpp_std }} \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DBUILD_TESTS=ON \
            -DBUILD_BENCHMARKS=ON

      - name: Configure (Windows, VS 2022)
        if: runner.os == 'Windows'
        shell: pwsh
        run: >
          cmake -S . -B build
          -G "Visual Studio 17 2022"
          -A x64
          -DCMAKE_CXX_STANDARD=${{ matrix.cpp_std }}
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          -DBUILD_TESTS=ON
          -DBUILD_BENCHMARKS=ON

      # ---- Build ----
      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: cmake --build build --parallel

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: cmake --build build --config Release --parallel

      # ---- Test ----
      - name: Run tests (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f build/CTestTestfile.cmake ]; then
            pushd build
            ctest --output-on-failure --parallel
            popd
          else
            echo "No tests configured."
          fi

      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path build/CTestTestfile.cmake) {
            Push-Location build
            ctest -C Release --output-on-failure --parallel
            Pop-Location
          } else {
            Write-Host "No tests configured."
          }

      # ---- Artifacts ----
      - name: Upload build artifact (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ matrix.compiler }}-std${{ matrix.cpp_std }}
          path: build

  # ---- clang-format ----
  clang-format-check:
    name: clang-format check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-format
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang-format
      - name: Check formatting
        shell: bash
        run: |
          set -euxo pipefail
          files="$(git ls-files '*.hpp' '*.h' '*.cpp' '*.c' | xargs || true)"
          if [ -z "$files" ]; then
            echo "No source files"
            exit 0
          fi
          bad=0
          for f in $files; do
            if ! clang-format -style=file "$f" | diff -u "$f" - >/dev/null; then
              echo "Not formatted: $f"
              bad=1
            fi
          done
          if [ $bad -ne 0 ]; then
            echo "Run clang-format -i on reported files."
            exit 2
          fi

  # ---- clang-tidy (quick) ----
  clang-tidy-scan:
    name: clang-tidy (quick)
    runs-on: ubuntu-latest
    needs: build-matrix
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-tidy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang-tidy
      - name: Configure compile_commands.json (Ninja)
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_CXX_STANDARD=23 \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_BENCHMARKS=OFF
      - name: Run clang-tidy on headers (limited)
        run: |
          if [ -f build/compile_commands.json ]; then
            find include -type f \( -name '*.hpp' -o -name '*.h' \) | head -n 50 | xargs -r clang-tidy -p build || true
          else
            echo "No compile_commands.json; skipping"
          fi
